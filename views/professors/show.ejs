<% layout('layouts/boilerplate') %>

<div class="container py-5">
  <div class="card shadow border-0 rounded-4 p-4">
    <div class="d-flex align-items-center mb-4">
      <img src="<%= professor.image && professor.image.url ? professor.image.url : '/images/default-professor.jpg' %>" 
     alt="<%= professor.name %>" 
     class="rounded-circle me-4 border" 
     style="width:120px; height:120px; object-fit:cover;">

      <div>
        <h2 class="fw-bold mb-0"><%= professor.name %></h2>
        <p class="text-muted mb-1"><%= professor.department %></p>
        <p class="text-muted mb-0"><%= professor.university %></p>
      </div>
      <div class="ms-auto text-center">
  <h4 class="text-warning fw-bold">
    Overall Rating: <%= professor.averageRating ? professor.averageRating.toFixed(2) : "N/A" %> ‚òÖ
  </h4>
  <small class="text-muted">(Overall average)</small>
</div>

    </div>
    <% if (currentUser && currentUser.isAdmin) { %>
  <div class="mt-3 d-flex justify-content-end">
    <a href="/professors/<%= professor._id %>/edit" class="btn btn-warning me-2">Edit</a>

    <form 
      action="/professors/<%= professor._id %>?_method=DELETE" 
      method="POST" 
      onsubmit="return confirm('Are you sure you want to delete this professor? This action cannot be undone.')"
    >
      <button class="btn btn-danger">Delete</button>
    </form>
  </div>
<% } %>


    <hr>

    <!-- Ratings Section -->
    <div class="row text-center mb-4">
      <div class="col-md-4">
        <h5 class="fw-semibold">Attendance</h5>
        <div class="progress custom-progress">
          <div 
            class="progress-bar bg-warning" 
            role="progressbar"
            style="width: <%= (attendanceAvg / 5) * 100 %>%;">
          </div>
        </div>
        <p class="mb-0 mt-2"><%= attendanceAvg.toFixed(1) %> / 5</p>
        <small class="text-muted">based on <%= professor.reviews.length %> rating(s)</small>
      </div>

      <div class="col-md-4">
        <h5 class="fw-semibold">Grading (Fairness)</h5>
        <div class="progress custom-progress">
          <div 
            class="progress-bar bg-info" 
            role="progressbar"
            style="width: <%= (gradingAvg / 5) * 100 %>%;">
          </div>
        </div>
        <p class="mb-0 mt-2"><%= gradingAvg.toFixed(1) %> / 5</p>
        <small class="text-muted">based on <%= professor.reviews.length %> rating(s)</small>
      </div>

      <div class="col-md-4">
        <h5 class="fw-semibold">Final Year Project Support</h5>
        <div class="progress custom-progress">
          <div 
            class="progress-bar bg-success" 
            role="progressbar"
            style="width: <%= (fypAvg / 5) * 100 %>%;">
          </div>
        </div>
        <p class="mb-0 mt-2"><%= fypAvg.toFixed(1) %> / 5</p>
        <small class="text-muted">based on <%= professor.reviews.length %> rating(s)</small>
      </div>
    </div>

    <hr>
<!-- Comments Section -->
<h4 class="fw-bold mb-3">Student Reviews</h4>

<% if (professor.reviews && professor.reviews.length > 0) { %>
  <% professor.reviews.forEach(review => { %>
    <div class="border rounded-3 p-3 mb-3 review-box shadow-sm">
      <div class="d-flex justify-content-between">
        <strong><%= review.author.username %></strong>
       <%
  const individualAvg = ((review.attendance + review.grading + review.fypSupport) / 3).toFixed(1);
  const stars = Math.round(individualAvg);
%>
<span class="text-warning">
  <% for (let i = 0; i < stars; i++) { %>‚≠ê<% } %>
  <small class="text-muted"><%= individualAvg %>/5</small>
</span>

      </div>

      <p class="mb-1 mt-2"><%= review.body %></p>
      <small class="text-muted">
        <%= review.createdAt ? review.createdAt.toDateString() : "Date not available" %>
      </small>

      <!-- üëá Show edit/delete buttons only if the current user is the review author or an admin -->
      <% if (currentUser && (review.author._id.equals(currentUser._id) || currentUser.isAdmin)) { %>
        <div class="mt-2">
          <a href="/professors/<%= professor._id %>/reviews/<%= review._id %>/edit"
             class="btn btn-sm btn-outline-primary">Edit</a>

          <form action="/professors/<%= professor._id %>/reviews/<%= review._id %>?_method=DELETE"
                method="POST"
                class="d-inline"
                onsubmit="return confirm('Are you sure you want to delete this review?');">
            <button class="btn btn-sm btn-outline-danger">Delete</button>
          </form>
        </div>
      <% } %>
    </div>
  <% }) %>
<% } else { %>
  <p class="text-muted">No reviews yet.</p>
<% } %>

    

    <% if (currentUser) { %>
      <hr>
      <h5 class="fw-bold mt-4 mb-3">Leave a Review</h5>
      <form action="/professors/<%= professor._id %>/reviews" method="POST">
        <div class="mb-3">
  <label class="form-label fw-semibold">Review (Optional)</label>
  <textarea name="review[body]" rows="3" class="form-control" placeholder="Share your experience (optional)..."></textarea>
</div>


        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <label class="form-label">Attendance</label>
            <select name="review[attendance]" class="form-select">
              <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
              <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê</option>
              <option value="3">‚≠ê‚≠ê‚≠ê</option>
              <option value="2">‚≠ê‚≠ê</option>
              <option value="1">‚≠ê</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">Grading (Fairness)</label>
            <select name="review[grading]" class="form-select">
              <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
              <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê</option>
              <option value="3">‚≠ê‚≠ê‚≠ê</option>
              <option value="2">‚≠ê‚≠ê</option>
              <option value="1">‚≠ê</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">Final Year Project Support</label>
            <select name="review[fypSupport]" class="form-select">
              <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
              <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê</option>
              <option value="3">‚≠ê‚≠ê‚≠ê</option>
              <option value="2">‚≠ê‚≠ê</option>
              <option value="1">‚≠ê</option>
            </select>
          </div>
        </div>

        <button class="btn btn-primary px-4">Submit</button>
      </form>
   <% } else { %>
  <p class="text-muted mt-3">
    You must be logged in to leave a review.
    <a href="/login" class="text-decoration-none fw-semibold">Login here</a>
  </p>
<% } %>

  </div>
</div>